<head>
	<meta charset="UTF-8" />
	<meta name="google" content="notranslate" />

	{%- if config.extra.csp -%}
		{%- include "partials/csp.html" -%}
	{%- endif -%}

	<meta name="description" content="{{ config.description }}" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<meta name="base" content="{{ config.base_url | safe }}" />
	{%- if zola_version -%}
		<meta name="generator" content="Zola {{ zola_version }}" />
	{%- else -%}
		<meta name="generator" content="Zola" />
	{%- endif -%}
    {% if is_404 %}
        <meta name="robots" content="noindex, follow" />
    {% endif %}

	{%- if page.extra.accent_color %}
		{%- set theme_color = page.extra.accent_color %}
	{%- elif section.extra.accent_color %}
		{%- set theme_color = section.extra.accent_color %}
	{%- elif config.extra.accent_color %}
		{%- set theme_color = config.extra.accent_color %}
	{%- endif %}

	{%- if theme_color and theme_color is iterable %}
		<meta name="theme-color" media="(prefers-color-scheme: light)" content="{{ theme_color[0] }}" />
		<meta name="theme-color" media="(prefers-color-scheme: dark)" content="{{ theme_color[1] }}" />
	{%- elif theme_color %}
		<meta name="theme-color" content="{{ theme_color }}" />
	{%- endif %}

	{%- if config.extra.fediverse.host and config.extra.fediverse.user %}
		<meta name="fediverse:creator" content="@{{ config.extra.fediverse.user }}@{{ config.extra.fediverse.host }}" />
	{%- endif %}

	{%- if page.extra.meta.card %}
		{%- set path_prefix = page.colocated_path | default(value="") -%}
		{%- set card = get_url(path=path_prefix ~ page.extra.card, cachebust=true) %}
	{%- elif section.extra.meta.card %}
		{%- set path_prefix = section.colocated_path | default(value="") -%}
		{%- set card = get_url(path=path_prefix ~ section.extra.card, cachebust=true) %}
	{%- elif page.extra.banner %}
		{%- set path_prefix = page.colocated_path | default(value="") -%}
		{%- set card = resize_image(path=path_prefix ~ page.extra.banner, width=1200, height=628, op="fill") %}
		{%- set card = card.url %}
	{%- elif section.extra.banner %}
		{%- set path_prefix = section.colocated_path | default(value="") -%}
		{%- set card = resize_image(path=path_prefix ~ section.extra.banner, width=1200, height=628, op="fill") %}
		{%- set card = card.url %}
	{%- elif config.extra.meta.card %}
		{%- if config.extra.meta.card != true %}
			{%- set card = get_url(path=config.extra.meta.card, cachebust=true) %}
		{%- else %}
			{%- set card = get_url(path="card.png", cachebust=true) %}
		{%- endif %}
	{%- endif %}

	<meta property="og:site_name" content="{{ config.title }}" />
	<meta property="og:title" content="{% include 'partials/title.html' %}" />
	<meta property="og:url" content="{{ current_url | default(value='/') | safe }}" />
	<meta property="og:description" content="{% include 'partials/description.html' %}" />
	{%- if card %}
		<meta property="og:image" content="{{ card | safe }}" />
	{%- endif %}
	<meta property="og:locale" content="{{ config.extra.date_locale | default(value='en_US') }}" />

	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:title" content="{% include 'partials/title.html' %}" />
	<meta name="twitter:url" content="{{ current_url | default(value='/') | safe }}" />
	<meta name="twitter:description" content="{% include 'partials/description.html' %}" />
	{%- if card %}
		<meta name="twitter:image" content="{{ card | safe }}" />
	{%- endif %}

	<title>{% include "partials/title.html" %}</title>
	<link rel="canonical" href="{{ current_url | default(value='/') | safe }}" />

	{%- if config.extra.fediverse.host and config.extra.fediverse.user %}
		<link rel="me" href="https://{{ config.extra.fediverse.host }}/@{{ config.extra.fediverse.user }}" />
	{%- endif %}

	{%- set is_global_favicon = true %}
	{%- if page.extra.meta.favicon %}
		{%- set path_prefix = page.colocated_path | default(value="") -%}
		{%- set favicon = path_prefix ~ page.extra.meta.favicon %}
		{%- set is_global_favicon = false %}
	{%- elif section.extra.meta.favicon %}
		{%- set path_prefix = section.colocated_path | default(value="") -%}
		{%- set favicon = path_prefix ~ section.extra.meta.favicon %}
		{%- set is_global_favicon = false %}
	{%- elif config.extra.meta.favicon %}
		{%- if config.extra.meta.favicon != true %}
			{%- set favicon = config.extra.meta.favicon %}
		{%- else %}
			{%- set favicon = "favicon.png" %}
		{%- endif %}
	{%- endif %}

	{%- if favicon %}
		{%- if favicon | split(pat=".") | length > 1 %}
			{%- set favicon_type = favicon | split(pat=".") | last %}
			{%- if favicon_type == "ico" %}
				{%- set favicon_type = "x-icon" %}
			{%- elif favicon_type == "svg" %}
				{%- set favicon_type = "svg+xml" %}
			{%- endif %}
			<link rel="icon" type="image/{{ favicon_type }}" href="{{ get_url(path=favicon, cachebust=true) }}" />
		{%- else %}
			<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='50%25' x='50%25' dominant-baseline='central' text-anchor='middle' font-size='88'%3E{{ favicon | truncate(length=1, end='') }}%3C/text%3E%3C/svg%3E" />
		{%- endif %}
		{%- if is_global_favicon %}
			<link rel="icon" type="image/svg+xml" href="{{ get_url(path='favicon.svg', cachebust=true) }}" />
			<link rel="alternate icon" href="{{ get_url(path='favicon.ico', cachebust=true) }}" />
			<link rel="icon" type="image/png" sizes="192x192" href="{{ get_url(path='icon-192.png', cachebust=true) }}" />
			<link rel="icon" type="image/png" sizes="512x512" href="{{ get_url(path='icon-512.png', cachebust=true) }}" />
		{%- endif %}
	{%- endif %}

	{%- if page.extra.meta.apple_touch_icon %}
		{%- set path_prefix = page.colocated_path | default(value="") -%}
		{%- set apple_touch_icon = get_url(path=path_prefix ~ page.extra.apple_touch_icon, cachebust=true) %}
	{%- elif section.extra.meta.apple_touch_icon %}
		{%- set path_prefix = section.colocated_path | default(value="") -%}
		{%- set apple_touch_icon = get_url(path=path_prefix ~ section.extra.apple_touch_icon, cachebust=true) %}
	{%- elif config.extra.meta.apple_touch_icon %}
		{%- if config.extra.meta.apple_touch_icon != true %}
			{%- set apple_touch_icon = get_url(path=config.extra.meta.apple_touch_icon, cachebust=true) %}
		{%- else %}
			{%- set apple_touch_icon = get_url(path="apple-touch-icon.png", cachebust=true) %}
		{%- endif %}
	{%- endif %}

	{%- if apple_touch_icon %}
		{%- set apple_touch_icon_type = apple_touch_icon | split(pat=".") | last %}
		<link rel="apple-touch-icon" type="image/{{ apple_touch_icon_type }}" sizes="180x180" href="{{ apple_touch_icon | safe }}" />
	{%- endif %}

	{%- set show_feeds = false %}
	{%- if config.generate_feeds %}
		{%- set show_feeds = true %}
	{%- elif section is defined and section.generate_feeds %}
		{%- set show_feeds = true %}
	{%- elif taxonomy is defined and taxonomy.feed and term is defined and term.path %}
		{%- set show_feeds = true %}
	{%- endif %}

	{%- if show_feeds and config.feed_filenames is defined %}
		{%- for feed_filename in config.feed_filenames %}
			{%- set final_feed_filename = feed_filename %}
			{%- if section is defined and section.generate_feeds %}
				{%- set final_feed_filename = current_path ~ feed_filename %}
			{%- endif %}
			{%- if taxonomy is defined and taxonomy.feed and term is defined and term.path %}
				{%- set final_feed_filename = term.path ~ feed_filename %}
			{%- endif %}
			{%- if final_feed_filename is containing("atom") %}
				<link rel="alternate" type="application/atom+xml" href="{{ get_url(path=final_feed_filename, lang=lang) }}" />
			{%- elif final_feed_filename is containing("rss") %}
				<link rel="alternate" type="application/rss+xml" href="{{ get_url(path=final_feed_filename, lang=lang) }}" />
			{%- else %}
				<link rel="alternate" href="{{ get_url(path=final_feed_filename, lang=lang) }}" />
			{%- endif %}
		{%- endfor %}
	{%- endif %}

	{%- set geist_version = "1.5.1" -%}
	{%- set geist_version_string = "?v=" ~ geist_version -%}
	<link rel="preload" href="{{ get_url(path='fonts/geist.woff2') ~ geist_version_string }}" as="font" type="font/woff2" crossorigin />
	<link rel="preload" href="{{ get_url(path='fonts/geist-italic.woff2') ~ geist_version_string }}" as="font" type="font/woff2" crossorigin />
	<link rel="preload" href="{{ get_url(path='fonts/geist-mono.woff2') ~ geist_version_string }}" as="font" type="font/woff2" crossorigin />
	<link rel="preload" href="{{ get_url(path='fonts/geist-mono-italic.woff2') ~ geist_version_string }}" as="font" type="font/woff2" crossorigin />

	{%- set styles = ["style.css"] %}

	{%- if config.extra.styles %}
		{%- set styles = styles | concat(with=config.extra.styles) %}
	{%- endif %}

	{%- if page.extra.styles %}
		{%- set styles = styles | concat(with=page.extra.styles) %}
	{%- elif section.extra.styles %}
		{%- set styles = styles | concat(with=section.extra.styles) %}
	{%- endif %}

	{%- if not config.extra.debug.no_styles %}
		{%- for style in styles %}
			<link type="text/css" rel="stylesheet" href="{{ get_url(path=style, cachebust=true) | safe }}" />
		{%- endfor %}

		{%- if config.markdown.highlight_code and config.markdown.highlight_theme == "css" %}
			{%- if config.markdown.highlight_themes_css is iterable %}
				<link type="text/css" rel="stylesheet" href="{{ get_url(path='syntax-theme-light.css', cachebust=true) }}" media="(prefers-color-scheme: light)" />
				<link type="text/css" rel="stylesheet" href="{{ get_url(path='syntax-theme-dark.css', cachebust=true) }}" media="(prefers-color-scheme: dark)" />
			{%- else %}
				<link type="text/css" rel="stylesheet" href="{{ get_url(path='syntax-theme.css', cachebust=true) }}" />
			{%- endif %}
		{%- endif %}
	{%- endif %}

	{%- if config.extra.debug.layout -%}
		<style type="text/css">
			*,
			*::before,
			*::after {
				outline: solid 1px var(--accent-color);
			}
		</style>
	{%- endif -%}

	{%- set scripts = ["closable.js", "deanchor.js", "marquee.js"] %}

	{%- if config.build_search_index %}
		{%- if config.search.index_format and config.search.index_format == "elasticlunr_javascript" %}
			{%- set search_index = "search_index." ~ lang ~ ".js" %}
			{%- set scripts = scripts | concat(with=[search_index, "elasticlunr.min.js", "search.js"]) %}
		{%- else %}
			{%- set scripts = scripts | concat(with=["elasticlunr.min.js", "search.js"]) %}
		{%- endif %}
	{%- endif %}

	{%- if page.extra.copy_button
		or section.extra.copy_button
		or config.extra.copy_button %}
		{%- set scripts = scripts | concat(with=["copy-button.js"]) %}
	{%- endif %}

	{%- if page.extra.audio_button
		or section.extra.audio_button
		or config.extra.audio_button %}
		{%- set scripts = scripts | concat(with=["audio-button.js"]) %}
	{%- endif %}

	{%- if page.extra.music and page.extra.music | length > 1
		or section.extra.music and section.extra.music | length > 1 %}
		{%- set scripts = scripts | concat(with=["paginator.js"]) %}
	{%- endif %}

	{%- if page.extra.fediverse.id %}
		{%- set scripts = scripts | concat(with=["comments.js"]) %}
	{%- endif %}

	{%- if config.extra.scripts %}
		{%- set scripts = scripts | concat(with=config.extra.scripts) %}
	{%- endif %}

	{%- if page.extra.scripts %}
		{%- set scripts = scripts | concat(with=page.extra.scripts) %}
	{%- elif section.extra.scripts %}
		{%- set scripts = scripts | concat(with=section.extra.scripts) %}
	{%- endif %}

	{%- if config.mode != "serve" and config.extra.vercel.analytics %}
		{%- if config.extra.vercel.rewrites_source -%}
			{%- set insights_url = get_url(path=config.extra.vercel.rewrites_source ~  "/insights/script.js") -%}
		{%- else -%}
			{%- set insights_url = get_url(path="_vercel/insights/script.js") -%}
		{%- endif -%}
		<script type="text/javascript" async src="{{ insights_url | safe }}" {% if config.extra.vercel.rewrites_source %}data-endpoint="/{{ config.extra.vercel.rewrites_source }}/insights"{% endif %}></script>
	{%- endif %}

	{%- if config.mode != "serve" and config.extra.vercel.speed_insights %}
		{%- if config.extra.vercel.rewrites_source -%}
			{%- set speed_insights_url = get_url(path=config.extra.vercel.rewrites_source ~  "/speed-insights/script.js") -%}
		{%- else -%}
			{%- set speed_insights_url = get_url(path="_vercel/speed-insights/script.js") -%}
		{%- endif -%}
		<script type="text/javascript" async src="{{ speed_insights_url | safe }}" {% if config.extra.vercel.rewrites_source %}data-endpoint="/{{ config.extra.vercel.rewrites_source }}/speed-insights/vitals"{% endif %}></script>
	{%- endif %}

	{%- for script in scripts %}
		<script type="text/javascript" defer src="{{ get_url(path=script, cachebust=true) | safe }}"></script>
	{%- endfor %}

	{%- if config.mode != "serve" and config.extra.analytics.service -%}
		{%- include "partials/analytics.html" -%}
	{%- endif -%}

	<script>
		(function() {
			const lang = navigator.language || navigator.userLanguage;
			if (!localStorage.getItem('user_lang_pref') && lang && lang.toLowerCase().startsWith('es')) {
				const path = window.location.pathname;
				if (!path.startsWith('/es/') && path !== '/es') {
					window.location.replace('/es' + path);
				}
			}
			document.addEventListener('click', function(e) {
				const link = e.target.closest('a[lang]');
				if (link) {
					localStorage.setItem('user_lang_pref', link.getAttribute('lang'));
				}
			});
		})();
	</script>

	<!-- Theme toggle inline script to prevent flash -->
	<script>
		(function() {
			const STORAGE_KEY = 'theme-preference';
			const THEME_AUTO = 'auto';
			const saved = localStorage.getItem(STORAGE_KEY) || THEME_AUTO;
			const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
			const theme = saved === THEME_AUTO ? (systemDark ? 'dark' : 'light') : saved;
			document.documentElement.setAttribute('data-theme', theme);
			document.documentElement.style.colorScheme = theme;
		})();
	</script>
</head>

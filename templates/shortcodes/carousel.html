{% set prefix = prefix | default(value="") %}
{% set extension = extension | default(value=".png") %}
{% set manual_images = images | default(value=[]) %}
{% set range_images = [] %}

{% if start is defined and end is defined %}
    {% for i in range(start=start, end=end + 1) %}
        {% set_global range_images = range_images | concat(with=prefix ~ i ~ extension) %}
    {% endfor %}
{% endif %}

{% set final_images = manual_images | concat(with=range_images) %}
{% set speed = speed | default(value=5) %}

<div class="carousel-marquee-wrapper {{ class | default(value='') }}" style="{{ style | default(value='') }}">
    <div class="carousel-marquee">
        <ul style="--duration: {{ final_images | length * speed }}s">
            {% for image in final_images %}
                <li>
                    <img src="{{ image }}#transparent" class="no-hover lightbox-trigger" alt="Slide {{ loop.index }}" loading="lazy" />
                </li>
            {% endfor %}
        </ul>
        <ul style="--duration: {{ final_images | length * speed }}s" aria-hidden="true">
            {% for image in final_images %}
                <li>
                    <img src="{{ image }}#transparent" class="no-hover lightbox-trigger" alt="Slide {{ loop.index }} (clone)" loading="lazy" />
                </li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="lightbox-overlay">
    <div class="lightbox-nav lightbox-prev" aria-label="Previous image">
        <svg class="lightbox-arrow-icon" viewBox="0 0 24 24" fill="white">
            <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
        </svg>
    </div>
    <img class="lightbox-img" src="" alt="Full size view" />
    <div class="lightbox-nav lightbox-next" aria-label="Next image">
        <svg class="lightbox-arrow-icon" viewBox="0 0 24 24" fill="white">
            <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
        </svg>
    </div>
</div>

<script>
(function() {
    const script = document.currentScript;
    const lightbox = script.previousElementSibling;
    const wrapper = lightbox.previousElementSibling;
    const triggers = Array.from(wrapper.querySelectorAll('.lightbox-trigger'));
    
    // Lightbox elements
    const lightboxImg = lightbox.querySelector('.lightbox-img');
    const prevBtn = lightbox.querySelector('.lightbox-prev');
    const nextBtn = lightbox.querySelector('.lightbox-next');
    
    let currentSrcs = triggers.map(t => t.src);
    let currentIndex = 0;
    
    function init() {
        triggers.forEach((img, index) => {
            img.addEventListener('click', () => openLightbox(index));
        });

        prevBtn.addEventListener('click', (e) => { e.stopPropagation(); prevLightboxSlide(); });
        nextBtn.addEventListener('click', (e) => { e.stopPropagation(); nextLightboxSlide(); });

        document.addEventListener('keydown', (e) => {
            if (!lightbox.classList.contains('visible')) return;
            if (e.key === 'Escape') closeLightbox();
            else if (e.key === 'ArrowLeft') { e.preventDefault(); prevLightboxSlide(); }
            else if (e.key === 'ArrowRight') { e.preventDefault(); nextLightboxSlide(); }
        });
        
        lightbox.addEventListener('click', (e) => { if (e.target === lightbox) closeLightbox(); });
    }
    
    function openLightbox(index) {
        currentIndex = index;
        updateLightboxImage();
        lightbox.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
    
    function closeLightbox() {
        lightbox.classList.remove('visible');
        document.body.style.overflow = '';
    }
    
    function updateLightboxImage() {
        if (currentIndex < 0) currentIndex = currentSrcs.length - 1;
        if (currentIndex >= currentSrcs.length) currentIndex = 0;
        lightboxImg.src = currentSrcs[currentIndex];
    }
    
    function nextLightboxSlide() { currentIndex++; updateLightboxImage(); }
    function prevLightboxSlide() { currentIndex--; updateLightboxImage(); }
    
    init();
})();
</script>



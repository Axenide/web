{% import "macros/icon.html" as macros_icon %}
{% set invite_code = "gHG9WHyNvH" %}
{# Fetch data at build time for instant loading/fallback #}
{% set data = load_data(url="https://discord.com/api/invites/" ~ invite_code ~ "?with_counts=true", format="json") %}

{# Define labels from parameters with language defaults #}
{% if lang == "es" %}
  {% set def_about = "Sobre â†“" %}
  {% set def_rules = "Reglas â†’" %}
  {% set def_join = "Unirse â†’" %}
  {% set def_online = "En lÃ­nea" %}
  {% set def_members = "Miembros" %}
  {% set def_about_id = "#sobre" %}
  {% set def_rules_id = "#reglas" %}
{% else %}
  {% set def_about = "About â†“" %}
  {% set def_rules = "Rules â†’" %}
  {% set def_join = "Join â†’" %}
  {% set def_online = "Online" %}
  {% set def_members = "Members" %}
  {% set def_about_id = "#about" %}
  {% set def_rules_id = "#rules" %}
{% endif %}

{% set label_about = about | default(value=def_about) %}
{% set label_rules = rules | default(value=def_rules) %}
{% set label_join = join | default(value=def_join) %}
{% set label_online = online | default(value=def_online) %}
{% set label_members = members | default(value=def_members) %}

{# New parameters for link IDs #}
{% set about_id = about_link | default(value=def_about_id) %}
{% set rules_id = rules_link | default(value=def_rules_id) %}

{% set server_desc = description | default(value="Cozy and welcoming space for cool people to hang out in.") %}

<section class="snap-section hero-wrapper discord-hero-wrapper">
	<div class="hero-container">
		<div id="guild-widget">
			<div id="guild-banner" style="--banner: url('{% if data.guild.banner %}https://cdn.discordapp.com/banners/{{ data.guild.id }}/{{ data.guild.banner }}.webp?size=1024{% else %}https://cdn.discordapp.com/icons/{{ data.guild.id }}/{{ data.guild.icon }}.webp?size=128{% endif %}');">
				<img
					id="guild-icon"
					class="transparent no-hover"
					src="https://cdn.discordapp.com/icons/{{ data.guild.id }}/{{ data.guild.icon }}.webp?size=128"
					alt="Server icon."
					{% if config.markdown.lazy_async_image %}
						decoding="async" loading="lazy"
					{% endif %}
				/>
			</div>
			<strong id="guild-name" class="title">{{ data.guild.name }}</strong>
			<p id="guild-stats">
				<span id="online-count">{{ data.approximate_presence_count }} {{ label_online }}</span>
				<span id="member-count">{{ data.approximate_member_count }} {{ label_members }}</span>
			</p>
			<p id="guild-description">{{ server_desc }}</p>
			<ul id="guild-traits">
				{% if data.profile and data.profile.traits %}
					{% for trait in data.profile.traits %}
						<li>
							{% if trait.emoji_name == "keyboard" %}âŒ¨ï¸
							{% elif trait.emoji_name == "tada" %}ğŸ‰
							{% elif trait.emoji_name == "sparkles" %}âœ¨
							{% elif trait.emoji_name == "flag_es" %}ğŸ‡ªğŸ‡¸
							{% elif trait.emoji_name == "flag_gb" %}ğŸ‡¬ğŸ‡§
							{% elif trait.emoji_name == "art" %}ğŸ¨
							{% elif trait.emoji_name == "video_game" %}ğŸ®
							{% elif trait.emoji_name == "music" %}ğŸµ
							{% elif trait.emoji_name == "musical_note" %}ğŸµ
							{% elif trait.emoji_name == "watermelon" %}ğŸ‰
							{% elif trait.emoji_name == "computer" %}ğŸ’»
							{% elif trait.emoji_name == "speech_balloon" %}ğŸ’¬
							{% endif %}
							{{ trait.label }}
						</li>
					{% endfor %}
				{% else %}
					<li>ğŸ’« Silly</li>
					<li>ğŸ—£ï¸ Multi-topic</li>
					<li>ğŸ’œ Friendly</li>
				{% endif %}
			</ul>
			<div class="buttons start">
				<a href="{{ about_id }}">{{ label_about }}</a>
				<a href="{{ rules_id }}">{{ label_rules }}</a>
				<a id="guild-invite" class="suggested" href="https://discord.com/invite/{{ invite_code }}">{{ label_join }}</a>
			</div>
			<div id="hover-map">
				<div class="top-left"></div>
				<div class="top-middle"></div>
				<div class="top-right"></div>
				<div class="middle-left"></div>
				<div class="middle"></div>
				<div class="middle-right"></div>
				<div class="bottom-left"></div>
				<div class="bottom-middle"></div>
				<div class="bottom-right"></div>
			</div>
		</div>
	</div>
</section>

<script>
document.addEventListener("DOMContentLoaded", async () => {
	const INVITE_CODE = "{{ invite_code }}";
  const labelOnline = "{{ label_online }}";
  const labelMembers = "{{ label_members }}";
  
  const emojiMap = {
    "keyboard": "âŒ¨ï¸", "tada": "ğŸ‰", "sparkles": "âœ¨", "flag_es": "ğŸ‡ªğŸ‡¸", "flag_gb": "ğŸ‡¬ğŸ‡§",
    "art": "ğŸ¨", "video_game": "ğŸ®", "music": "ğŸµ", "musical_note": "ğŸµ", "watermelon": "ğŸ‰",
    "computer": "ğŸ’»", "speech_balloon": "ğŸ’¬"
  };

	async function updateDiscordInfo() {
		try {
			const response = await fetch(`https://discord.com/api/invites/${INVITE_CODE}?with_counts=true`);
			const data = await response.json();
			if (data.guild) {
				document.getElementById("guild-name").textContent = data.guild.name;
				
				if (data.guild.icon) {
					const iconUrl = `https://cdn.discordapp.com/icons/${data.guild.id}/${data.guild.icon}.webp?size=128`;
					document.getElementById("guild-icon").src = iconUrl;
					const bannerElement = document.getElementById("guild-banner");
					if (data.guild.banner) {
						bannerElement.style.setProperty('--banner', `url('https://cdn.discordapp.com/banners/${data.guild.id}/${data.guild.banner}.webp?size=1024')`);
					} else {
						bannerElement.style.setProperty('--banner', `url('${iconUrl}')`);
					}
				}

				document.getElementById("online-count").textContent = `${data.approximate_presence_count} ${labelOnline}`;
				document.getElementById("member-count").textContent = `${data.approximate_member_count} ${labelMembers}`;

				if (data.profile && data.profile.traits) {
					const traits = data.profile.traits.map(trait => {
            const emoji = emojiMap[trait.emoji_name] || trait.emoji_name || "";
						return `<li>${emoji} ${trait.label}</li>`;
					}).join("");
					document.getElementById("guild-traits").innerHTML = traits;
				}
			}
		} catch (e) {}
	}
	updateDiscordInfo();
});
</script>

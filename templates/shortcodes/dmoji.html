{%- set emoji_id = "" -%}
{%- set ext = "png" -%}

{# 1. Try Direct ID #}
{%- if id -%}
    {%- set emoji_id = id -%}
    {%- if animated -%}{%- set ext = "gif" -%}{%- endif -%}

{# 2. Try fetching from Discord API directly #}
{%- elif name -%}
    {%- set app_id = get_env(name="AXIE_CLIENT_ID", default="NO_ID") -%}
    {%- set token = get_env(name="AXIE_BOT_TOKEN", default="NO_TOKEN") -%}
    
    {%- if app_id != "NO_ID" and token != "NO_TOKEN" -%}
        {%- set remote_data = load_data(
            url="https://discord.com/api/v10/applications/" ~ app_id ~ "/emojis",
            format="json",
            method="GET",
            headers=["Authorization= Bot " ~ token],
            fail_on_error=false
        ) -%}
        
        {%- if remote_data and remote_data.items -%}
            {%- for item in remote_data.items -%}
                {%- if item.name == name -%}
                    {%- set_global emoji_id = item.id -%}
                    {%- if item.animated -%}
                        {%- set_global ext = "gif" -%}
                    {%- endif -%}
                    {%- break -%}
                {%- endif -%}
            {%- endfor -%}
        {%- endif -%}
    {%- endif -%}

    {# 3. Fallback to config.toml (Manual) if not found in API #}
    {%- if not emoji_id and config.extra.discord_emojis -%}
        {%- set val = config.extra.discord_emojis[name] | as_str -%}
        {%- if val -%}
            {%- if val is containing(".") -%}
                {%- set parts = val | split(pat=".") -%}
                {%- set emoji_id = parts[0] -%}
                {%- set ext = parts[1] -%}
            {%- else -%}
                {%- set emoji_id = val -%}
            {%- endif -%}
        {%- endif -%}
    {%- endif -%}
{%- endif -%}

{%- if emoji_id -%}
    <img 
        class="dmoji emoji no-hover transparent" 
        src="https://cdn.discordapp.com/emojis/{{ emoji_id }}.{{ ext }}" 
        alt=":{% if name %}{{ name }}{% else %}discord_emoji{% endif %}:"
        title=":{% if name %}{{ name }}{% else %}discord_emoji{% endif %}:"
        style="height: 1.2em; width: auto; vertical-align: -0.2em; display: inline-block; margin: 0; padding: 0 !important; border: none !important; box-shadow: none !important; background: transparent !important;"
    />
{%- else -%}
    <span style="color: red; font-weight: bold;">[dmoji error: '{{ name }}' not found]</span>
{%- endif -%}
